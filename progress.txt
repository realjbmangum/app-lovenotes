# Progress Log - LoveNotes

## Codebase Patterns
<!-- Add patterns here as you discover them -->
- Phone numbers: Format with `formatPhoneNumber()`, validate with `validatePhoneNumber()`, store as 10 digits only
- Form validation: Manual validation in `validateForm()`, clear errors on input change
- API calls: Use `lib/api.ts` client, returns `{ success, checkoutUrl?, error? }`
- **Auth**: JWT in httpOnly cookie (`lovenotes_auth`), 30-day expiry, requires `JWT_SECRET` env var
- **Protected endpoints**: `/api/subscriber`, `/api/messages/next` require auth cookie
- **CORS**: Pass `requestOrigin` parameter (no global state), allowed origins in `ALLOWED_ORIGINS` array
- **Testing**: Use `npm test` (vitest), test files named `*.test.ts`
- **Email security**: Always use `escapeHtml()` for user content in email templates
- **Form accessibility**: Use `aria-describedby` linking errors, `aria-invalid`, `role="alert"`
- **Themes**: romantic, funny, appreciative, encouraging, spicy (5 total)
- **Occasions**: anniversary, birthday, valentines, christmas, mothers_day, thanksgiving, new_years

---

## Session Log

### 2026-01-09 - Project Setup & Story 1 Complete

**Completed:**
- Extracted starter project from love-notes.zip
- Created PRD with 6 user stories
- Implemented Story 1: Landing Page Polish
  - Form validation (email, phone, wife name)
  - Phone number auto-formatting
  - Error states with visual feedback
  - API submission to `/api/signup`
- Created success page at `/success`
- Created mock API route for local dev

**Files Changed:**
- `app/page.tsx` - Added validation, error states, API integration
- `app/success/page.tsx` - New success confirmation page
- `app/api/signup/route.ts` - Mock API for local dev
- `lib/api.ts` - API client with validation helpers
- `tasks/prd-lovenotes-mvp.md` - Full PRD document
- `CLAUDE.md` - Project context

**Decisions:**
- Using mock API route for local dev, will replace with Cloudflare Worker
- Phone stored as 10 digits, formatted on display only
- Default theme: romantic, default frequency: daily
- Success page uses URL param for wife's name

**Learnings:**
- Next.js 15.2.6 has a security vulnerability - should upgrade
- shadcn/ui already installed with full component library

**Next Steps:**
- Story 2: Stripe Checkout Integration
- Set up Cloudflare Worker project
- Create D1 database schema

---

### 2026-01-09 - Story 4: Message Library (Batch 1)

**Completed:**
- Created 560 messages across all themes
- Built compile script to generate SQL from JSON
- Created D1 schema with all tables and indexes

**Message Count:**
- Romantic: 250 (200 daily + 50 occasions)
- Funny: 100
- Appreciative: 110 (100 daily + 10 Mother's Day)
- Encouraging: 100
- Special occasions: 60 (10 each for anniversary, birthday, Valentine's, Mother's Day, Christmas, just because)

**Files Created:**
- `data/messages/romantic-001.json` (100 messages)
- `data/messages/romantic-002.json` (100 messages)
- `data/messages/funny-001.json` (100 messages)
- `data/messages/appreciative-001.json` (100 messages)
- `data/messages/encouraging-001.json` (100 messages)
- `data/messages/occasions.json` (60 messages)
- `data/schema.sql` - D1 database schema
- `data/seed-messages.sql` - Compiled SQL inserts
- `scripts/compile-messages.js` - JSON to SQL compiler

**Patterns:**
- Messages use `{wife_name}` placeholder - replaced at send time
- Occasion field is NULL for daily messages, set for special dates
- IDs are auto-generated in D1, not from JSON

**Next Steps:**
- Generate more messages to reach 730 per theme (currently at ~100-250 each)
- Or proceed with current set for MVP launch
- Story 2 (Stripe) or Story 5 (SMS) when ready

---

### 2026-01-20 - Security Fixes & Test Infrastructure

**Completed:**
- Implemented JWT authentication with httpOnly cookies
- Fixed CORS to use specific origins (not `*`)
- Gated test endpoint behind environment check (blocked in production)
- Added server-side input validation (email regex, phone digits, name sanitization)
- Updated dashboard to use cookie-based auth
- Added vitest test infrastructure with initial tests

**Files Changed:**
- `worker/index.ts` - JWT auth, CORS fix, input validation, env gating
- `wrangler.toml` - Added JWT_SECRET and ALLOWED_ORIGIN config
- `app/dashboard/page.tsx` - Cookie-based auth with `credentials: 'include'`
- `package.json` - Added test scripts
- `vitest.config.ts` - New test config
- `lib/api.test.ts` - New validation tests
- `CLAUDE.md` - Updated API docs with auth requirements

**Security Fixes:**
1. JWT auth replaces URL-based subscriber ID (was CRITICAL vulnerability)
2. CORS restricted to specific origins (was `*`)
3. Test endpoint blocked in production
4. Wife's name sanitized to prevent injection

**Decisions:**
- JWT expires in 30 days
- Using Web Crypto API for JWT (no external deps in Worker)
- SameSite=Lax for cookies (balance security/usability)
- Secure flag only in production (allows localhost dev)

**Next Steps:**
- [ ] Set JWT_SECRET in production: `wrangler secret put JWT_SECRET`
- [ ] Add more tests (API integration tests)
- [ ] Story 2: Stripe Checkout Integration
- [ ] Story 5: SMS Sender (Twilio)

---

### 2026-01-20 - Production Deployment & Email Integration

**Completed:**
- Fixed message style mismatch (signup now matches dashboard themes)
- Added "Random" theme option - picks different style each day
- Implemented daily scheduled worker (cron at 8am ET)
- Added anniversary/birthday checking in scheduled handler
- Fixed deployment size issue (static export to `out/` folder - 1.6MB)
- Deployed Worker to Cloudflare: `https://lovenotes-api.bmangum1.workers.dev`
- Fixed CORS for all Pages domains (dynamic origin matching)
- Added SendGrid email integration as SMS fallback
- Created test endpoint: `POST /api/test/send-message`
- Successful end-to-end signup test on live site

**Deployment:**
- Worker URL: `https://lovenotes-api.bmangum1.workers.dev`
- Pages URL: `https://app-lovenotes-nextjs.pages.dev`
- D1 Database: `lovenotes-db` (bound to worker)

**Files Changed:**
- `app/page.tsx` - Added "Random" theme option as default
- `app/dashboard/page.tsx` - Aligned themes with database (4 themes not 8)
- `worker/index.ts` - SendGrid email, scheduled handler, anniversary logic, CORS fix
- `wrangler.toml` - Cron trigger, SendGrid secrets reminder
- `next.config.mjs` - Static export enabled (`output: 'export'`)
- `lib/api.ts` - Production API URL auto-detection
- `package.json` - Added pages:build and pages:deploy scripts

**Environment Variables (Cloudflare Worker):**
- `JWT_SECRET` - ✅ Set
- `SENDGRID_API_KEY` - ⏳ Pending (user creating new key for LoveNotes)
- `SENDGRID_FROM_EMAIL` - ⏳ Pending
- `TWILIO_*` - Optional (for SMS)

**Message Flow:**
1. Daily cron at 8am ET (13:00 UTC)
2. Check for anniversary/birthday → send special message
3. Otherwise pick random theme for variety
4. Send via: Twilio SMS > SendGrid Email > Log only

**Built MCP for Domain Search:**
- Created `/Users/jbm/new-project/mcp-cloudflare-domains`
- Tools: check_domain, check_domains, search_domains
- Added to `~/.claude/settings.json`
- Uses Cloudflare Registrar API

**Decisions:**
- "Random" is now default theme (more variety for users)
- Static export for Cloudflare Pages (simpler, smaller)
- Email as fallback until Twilio configured
- Dashboard themes: romantic, funny, appreciative, encouraging (matches DB)

**Next Steps:**
- [ ] Set up SendGrid API key for LoveNotes domain
- [ ] Authenticate lovenotes domain in SendGrid (or pick domain name first)
- [ ] Test email sending via `/api/test/send-message`
- [ ] Pick and register domain name for LoveNotes
- [ ] Story 2: Stripe Checkout Integration
- [ ] Restart Claude Code to use new domain search MCP

---

### 2026-01-21 - Security Audit & Design Fixes

**Completed:**
- Ran full security review (C+ grade → fixed all critical/high issues)
- Ran design review and fixed accessibility issues
- Added Privacy Policy and Terms of Service pages
- Added 315 spicy theme messages
- Added holiday detection for occasion emails
- Added birthday field to signup form

**Security Fixes:**
1. **JWT secret fallback removed** (Critical) - No longer falls back to hardcoded dev secret
2. **JWT algorithm validation** (Critical) - Rejects tokens with unexpected algorithms
3. **CORS refactored** (Critical) - Eliminated mutable global state, pass origin as parameter
4. **Email enumeration fixed** (High) - Generic error "Unable to create account" instead of "Email already registered"
5. **localStorage removed** (High) - No longer stores subscriberId, auth uses httpOnly cookie only
6. **HTML injection fixed** (Medium) - Added `escapeHtml()` for all user content in emails

**Design/Accessibility Fixes:**
1. Updated metadata from "LoveNotes" to "SendMyLove"
2. Added `aria-describedby`, `aria-invalid`, `role="alert"` to form errors
3. Message cards now responsive: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-4`
4. Dashboard theme buttons responsive: `grid-cols-3 sm:grid-cols-5`

**New Features:**
- Privacy Policy page (`/privacy`)
- Terms of Service page (`/terms`)
- 315 spicy theme messages (R-rated, not X-rated)
- Spicy theme in dashboard and signup form
- Holiday detection: New Year's, Valentine's, Mother's Day, Thanksgiving, Christmas
- Wife's birthday field with special messages

**Files Changed:**
- `worker/index.ts` - Security fixes, HTML escaping, requestOrigin parameter
- `app/layout.tsx` - Updated metadata title
- `app/page.tsx` - Accessibility fixes, removed localStorage, responsive grid
- `app/dashboard/page.tsx` - Responsive theme buttons
- `app/privacy/page.tsx` - New Privacy Policy page
- `app/terms/page.tsx` - New Terms of Service page
- `data/messages/spicy.json` - 315 spicy messages
- `lib/api.ts` - Added wifeBirthday field

**Message Count (Updated):**
- Romantic: 850
- Funny: 400
- Appreciative: 410
- Encouraging: 400
- Spicy: 315
- Occasions: 140
- **Total: 2,515 messages**

**Commit:** `9e25d49` - fix(security): Address critical vulnerabilities and improve accessibility

**Next Steps:**
- [ ] Set up Stripe Checkout for payments
- [ ] Add Twilio for SMS delivery
- [ ] Consider rate limiting (medium priority)
- [ ] Add login flow for returning users

---
